import { console } from '@/controller/console'
import { Database } from '@/controller/Database'
import { Command, Discord } from '@/discord/base'
import Config from '@/entity/Config.entry'
import { EmbedBuilder, ApplicationCommandType, ApplicationCommandOptionType, type TextChannel, codeBlock, PermissionsBitField } from 'discord.js'

new Command({
  name: 'kick',
  dmPermission: false,
  description: '[ üíé Modera√ß√£o ] Expulsa um usu√°rio do servidor',
  defaultMemberPermissions: PermissionsBitField.Flags.KickMembers,
  type: ApplicationCommandType.ChatInput,
  options: [
    {
      name: 'usu√°rio',
      description: 'Usu√°rio que ser√° expulso',
      required: true,
      type: ApplicationCommandOptionType.User
    },
    {
      name: 'motivo',
      description: 'Motivo da expuls√£o',
      type: ApplicationCommandOptionType.String
    }
  ],
  async run (interaction) {
    const { guild, options, guildId } = interaction

    const user = options.getUser('usu√°rio')
    const reason = options.getString('motivo') ?? 'Nenhum motivo especificado'
    const logsDB = await new Database<Config>({ table: 'Config' }).findOne({ where: { guild: { id: guildId ?? undefined  }}, relations: { guild: true } })
    const logsChannel = logsDB?.logBanKick !== undefined ? await interaction.guild?.channels.fetch(logsDB?.logBanKick) as TextChannel : undefined

    if (user === null) return

    if (user.id === interaction.user.id) {
      const embed = new EmbedBuilder()
        .setColor('Yellow')
        .setDescription('‚ùå - Voc√™ n√£o pode se expulsar do servidor.')
      return await interaction.reply({ embeds: [embed], ephemeral: true })
    }

    if (user.id === Discord.client?.user?.id) {
      const unauthorizedEmbed = new EmbedBuilder()
        .setColor('Red')
        .setTitle('N√£o permitido!')
        .setDescription('Voc√™ quer me banir? t√° marcado!')
      return await interaction.reply({ embeds: [unauthorizedEmbed], ephemeral: true })
    }

    // Tenta banir o usu√°rio
    try {
      await guild?.members.kick(user, reason)
      // Adiciona o log de warning ap√≥s o comando ter sido executado
      console.log(
        `BAN: O usuario ${interaction.user.username} com o ID: ${interaction.user.id} expulsou o ${user.username} de ID: ${user.id}`
      )
      const embed = new EmbedBuilder()
        .setColor('Green')
        .setTitle('Usu√°rio expulso com sucesso!')
        .setDescription(
          `${user?.username} foi expulso do servidor.`
        )
        .addFields(
          {
            name: 'Usu√°rio expulso',
            value: codeBlock(`User: ${user?.username}\nID: ${user?.id}`)
          },
          { name: 'Motivo', value: reason },
          {
            name: 'Data e Hora',
            value: new Date().toLocaleString('pt-BR', {
              timeZone: 'America/Sao_Paulo'
            })
          }
        )

      if (logsChannel !== undefined) {
        void logsChannel.send({ embeds: [embed] })
      }

      return await interaction.reply({ embeds: [embed] })
    } catch (error) {
      console.error(error)
      return await interaction.reply({
        content: 'Ocorreu um erro ao expulsar o usu√°rio!',
        ephemeral: true
      })
    }
  }
})
